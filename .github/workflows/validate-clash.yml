name: Validate Clash Configurations

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    # paths:
    #   - '*.yaml'
    #   - '*.yml'
    #   - 'scripts/test-clash-configs.js'
  pull_request:
    branches: [main, master]
    # paths:
    #   - '*.yaml'
    #   - '*.yml'
    #   - 'scripts/test-clash-configs.js'

jobs:
  validate-clash:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Validate Clash configurations
        run: |
          echo "ğŸ§ª å¼€å§‹éªŒè¯ Clash é…ç½®æ–‡ä»¶..."
          npm run test:clash

      - name: Check if mihomo can parse configs
        run: |
          echo "ğŸ“¥ ä¸‹è½½ mihomo è¿›è¡Œé¢å¤–éªŒè¯..."
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz -O mihomo.gz
          gunzip mihomo.gz || gzip -d mihomo.gz

          # mv mihomo-linux-amd64 mihomo
          chmod +x mihomo

          echo "ğŸ” ä½¿ç”¨ mihomo éªŒè¯é…ç½®æ–‡ä»¶..."

          configs=()
          if [ -f "clash-output-consistenthashing.yaml" ]; then
            configs+=("clash-output-consistenthashing.yaml")
          fi
          if [ -f "clash-config-template.yaml" ]; then
            configs+=("clash-config-template.yaml")
          fi

          success=0
          total=${#configs[@]}

          for config in "${configs[@]}"; do
            echo "ğŸ“‹ æµ‹è¯•: $config"
            if timeout 30 ./mihomo -t -f "$config" > /dev/null 2>&1; then
              echo "   âœ… mihomo éªŒè¯é€šè¿‡"
              ((success++))
            else
              echo "   âŒ mihomo éªŒè¯å¤±è´¥"
              ./mihomo -t -f "$config" | head -10
            fi
          done

          echo "ğŸ“Š mihomo éªŒè¯ç»“æœ: $success/$total ä¸ªé…ç½®æ–‡ä»¶é€šè¿‡"

          if [ $success -eq $total ]; then
            echo "ğŸ‰ æ‰€æœ‰é…ç½®æ–‡ä»¶é€šè¿‡ mihomo éªŒè¯!"
          else
            echo "âš ï¸  éƒ¨åˆ†é…ç½®æ–‡ä»¶æœªé€šè¿‡ mihomo éªŒè¯"
            exit 1
          fi
