name: Test Xray Configurations

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'xray-config-template.json'
      - 'generate-xray-config.mjs'
      - 'é“¾æ¥ç”Ÿæˆå™¨.js'
      - 'ä¼˜é€‰åŸŸå.js'
      - 'package.json'
      - 'scripts/test-xray-configs.js'
  pull_request:
    branches: [main, master]
    paths:
      - 'xray-config-template.json'
      - 'generate-xray-config.mjs'
      - 'é“¾æ¥ç”Ÿæˆå™¨.js'
      - 'ä¼˜é€‰åŸŸå.js'
      - 'package.json'
      - 'scripts/test-xray-configs.js'

jobs:
  test-xray-configs:
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'ğŸ¤– Auto build')"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        #, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Generate configurations
        run: |
          echo "ğŸ”§ ç”Ÿæˆ Xray é…ç½®æ–‡ä»¶..."
          node generate-xray-config.mjs

      - name: Format code
        run: npm run format

      - name: Download Xray (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          echo "ğŸ“¥ ä¸‹è½½ Xray..."
          ARCH=$(uname -m)
          if [[ "$ARCH" == "arm64" ]]; then
            if [[ "$RUNNER_OS" == "macOS" ]]; then
              XRAY_ARCH="macos-arm64"
            else
              XRAY_ARCH="linux-arm64"
            fi
          else
            if [[ "$RUNNER_OS" == "macOS" ]]; then
              XRAY_ARCH="macos-64"
            else
              XRAY_ARCH="linux-64"
            fi
          fi

          echo "ğŸ¯ ç›®æ ‡æ¶æ„: $XRAY_ARCH"
          wget "https://github.com/XTLS/Xray-core/releases/download/v25.10.15/Xray-${XRAY_ARCH}.zip" -O xray.zip
          unzip -o xray.zip
          chmod +x xray
          ./xray version

      - name: Download Xray (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "ğŸ“¥ ä¸‹è½½ Xray (Windows)..."
          Invoke-WebRequest -Uri "https://github.com/XTLS/Xray-core/releases/download/v25.10.15/Xray-windows-64.zip" -OutFile "xray.zip"
          Expand-Archive -Path "xray.zip" -DestinationPath "." -Force
          ./xray.exe version

      - name: Generate VMess links
        run: |
          echo "ğŸ”— ç”Ÿæˆ VMess é“¾æ¥..."
          node "é“¾æ¥ç”Ÿæˆå™¨.js"
      - run: npm run test:config:verbose    

      - name: Test Xray configurations
        run: |
          echo "ğŸ§ª å¼€å§‹æµ‹è¯• Xray é…ç½®æ–‡ä»¶..."

          # æ£€æŸ¥å¯ç”¨çš„é…ç½®æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥å¯ç”¨çš„é…ç½®æ–‡ä»¶..."
          available_configs=()
          for config in xray-output-*.json; do
            if [[ -f "$config" ]]; then
              available_configs+=("$config")
              echo "   âœ… $config"
            fi
          done

          if [[ ${#available_configs[@]} -eq 0 ]]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½• Xray é…ç½®æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° ${#available_configs[@]} ä¸ªé…ç½®æ–‡ä»¶"

          success_count=0
          total_count=${#available_configs[@]}
          failed_configs=()

          # æµ‹è¯•æ¯ä¸ªé…ç½®æ–‡ä»¶
          for config in "${available_configs[@]}"; do
            echo ""
            echo "ğŸ“‹ æµ‹è¯•æ–‡ä»¶: $config"

            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ•è·æµ‹è¯•ç»“æœ
            if [[ "$RUNNER_OS" == "Windows" ]]; then
              temp_output=$(mktemp)
            else
              temp_output=$(mktemp)
            fi

            # æ‰§è¡Œ xray æµ‹è¯•å‘½ä»¤
            if [[ "$RUNNER_OS" == "Windows" ]]; then
              set +e
              timeout 30 ./xray.exe run -test -f "$config" > "$temp_output" 2>&1
              test_result=$?
              set -e
            else
              set +e
              timeout 30 ./xray run -test -c "$config" > "$temp_output" 2>&1
              test_result=$?
              set -e
            fi

            if [[ $test_result -eq 0 ]]; then
              echo "   âœ… é…ç½®æ–‡ä»¶æµ‹è¯•é€šè¿‡!"
              exit 0
              ((success_count++))
              rm -f "$temp_output"

              # éªŒè¯åŸºç¡€é…ç½®
              echo "   ğŸ” æ£€æŸ¥åŸºç¡€é…ç½®..."

              # æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„å‡ºç«™é…ç½®
              outbound_count=$(jq '.outbounds | length' "$config" 2>/dev/null || echo "0")
              echo "      ğŸ“Š å‡ºç«™é…ç½®æ•°é‡: $outbound_count"

              # æ£€æŸ¥æ˜¯å¦æœ‰vmessä»£ç†
              vmess_count=$(jq '.outbounds[] | select(.protocol=="vmess") | .protocol' "$config" 2>/dev/null | wc -l || echo "0")
              echo "      ğŸ”Œ VMess ä»£ç†æ•°é‡: $vmess_count"

              # æ£€æŸ¥æ˜¯å¦æœ‰directå’Œblockå‡ºç«™
              if jq -e '.outbounds[] | select(.tag=="direct")' "$config" >/dev/null 2>&1; then
                echo "      âœ… æ‰¾åˆ° direct å‡ºç«™"
              else
                echo "      âš ï¸ æœªæ‰¾åˆ° direct å‡ºç«™"
              fi

              if jq -e '.outbounds[] | select(.tag=="block")' "$config" >/dev/null 2>&1; then
                echo "      âœ… æ‰¾åˆ° block å‡ºç«™"
              else
                echo "      âš ï¸ æœªæ‰¾åˆ° block å‡ºç«™"
              fi

              # æ£€æŸ¥TLSé…ç½®
              if jq -e '.outbounds[0].streamSettings.security' "$config" >/dev/null 2>&1; then
                security=$(jq -r '.outbounds[0].streamSettings.security' "$config" 2>/dev/null)
                echo "      ğŸ”’ TLS å®‰å…¨é…ç½®: $security"
              fi

            else
              echo "   âŒ é…ç½®æ–‡ä»¶æµ‹è¯•å¤±è´¥ (é€€å‡ºç : $test_result)"
              failed_configs+=("$config")

              # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆé™åˆ¶è¡Œæ•°ä»¥é¿å…è¾“å‡ºè¿‡é•¿ï¼‰
              echo "   ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š"
              head -20 "$temp_output" 2>/dev/null || echo "   æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"

              # æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
              if [[ $test_result -eq 124 ]]; then
                echo "   â° æµ‹è¯•è¶…æ—¶ï¼ˆ30ç§’ï¼‰"
              fi

              rm -f "$temp_output"
            fi
          done

          echo ""
          echo "ğŸ“Š æµ‹è¯•ç»“æœ: $success_count/$total_count ä¸ªé…ç½®æ–‡ä»¶é€šè¿‡æµ‹è¯•"

          # æ˜¾ç¤ºå¤±è´¥çš„é…ç½®æ–‡ä»¶
          if [[ ${#failed_configs[@]} -gt 0 ]]; then
            echo ""
            echo "âŒ å¤±è´¥çš„é…ç½®æ–‡ä»¶ï¼š"
            for failed in "${failed_configs[@]}"; do
              echo "   - $failed"
            done
          fi

          if [[ $success_count -eq $total_count ]]; then
            echo ""
            echo "ğŸ‰ æ‰€æœ‰é…ç½®æ–‡ä»¶æµ‹è¯•é€šè¿‡!"
            echo "âœ… Xrayé…ç½®éªŒè¯å®Œæˆ"
          else
            echo ""
            echo "âš ï¸  éƒ¨åˆ†é…ç½®æ–‡ä»¶æµ‹è¯•å¤±è´¥"
            echo "ğŸ“ è¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi

      - name: Verify VMess links consistency
        run: |
          echo "ğŸ”— éªŒè¯ VMess é“¾æ¥ä¸€è‡´æ€§..."

          # æ£€æŸ¥IPv6é“¾æ¥æ–‡ä»¶
          if [[ -f "åˆ†äº«é“¾æ¥.txt" ]]; then
            link_count=$(grep -c "vmess://" "åˆ†äº«é“¾æ¥.txt" 2>/dev/null || echo "0")
            echo "ğŸ“‹ åˆ†äº«é“¾æ¥.txt ä¸­çš„ VMess é“¾æ¥æ•°é‡: $link_count"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° åˆ†äº«é“¾æ¥.txt æ–‡ä»¶"
          fi

          # æ£€æŸ¥IPv4é“¾æ¥æ–‡ä»¶
          if [[ -f "åˆ†äº«é“¾æ¥-ipv4.txt" ]]; then
            ipv4_link_count=$(grep -c "vmess://" "åˆ†äº«é“¾æ¥-ipv4.txt" 2>/dev/null || echo "0")
            echo "ğŸ“‹ åˆ†äº«é“¾æ¥-ipv4.txt ä¸­çš„ VMess é“¾æ¥æ•°é‡: $ipv4_link_count"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° åˆ†äº«é“¾æ¥-ipv4.txt æ–‡ä»¶"
          fi

          # éªŒè¯é…ç½®æ–‡ä»¶ä¸é“¾æ¥æ•°é‡çš„ä¸€è‡´æ€§
          if [[ -f "xray-output-random.json" ]] && [[ -f "åˆ†äº«é“¾æ¥.txt" ]]; then
            config_outbounds=$(jq '.outbounds | length' "xray-output-random.json" 2>/dev/null || echo "0")
            # å‡å» direct å’Œ block å‡ºç«™
            proxy_outbounds=$((config_outbounds - 2))
            echo "ğŸ“Š IPv6 é…ç½®æ–‡ä»¶ä»£ç†æ•°é‡: $proxy_outbounds"

            if [[ $proxy_outbounds -eq $link_count ]]; then
              echo "âœ… IPv6 é…ç½®æ–‡ä»¶ä¸é“¾æ¥æ•°é‡ä¸€è‡´"
            else
              echo "âš ï¸ IPv6 é…ç½®æ–‡ä»¶ä¸é“¾æ¥æ•°é‡ä¸ä¸€è‡´"
            fi
          fi

          if [[ -f "xray-output-random-ipv4.json" ]] && [[ -f "åˆ†äº«é“¾æ¥-ipv4.txt" ]]; then
            config_outbounds=$(jq '.outbounds | length' "xray-output-random-ipv4.json" 2>/dev/null || echo "0")
            # å‡å» direct å’Œ block å‡ºç«™
            proxy_outbounds=$((config_outbounds - 2))
            echo "ğŸ“Š IPv4 é…ç½®æ–‡ä»¶ä»£ç†æ•°é‡: $proxy_outbounds"

            if [[ $proxy_outbounds -eq $ipv4_link_count ]]; then
              echo "âœ… IPv4 é…ç½®æ–‡ä»¶ä¸é“¾æ¥æ•°é‡ä¸€è‡´"
            else
              echo "âš ï¸ IPv4 é…ç½®æ–‡ä»¶ä¸é“¾æ¥æ•°é‡ä¸ä¸€è‡´"
            fi
          fi

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xray-config-test-results-${{ matrix.os }}
          path: |
            xray-output-*.json
            åˆ†äº«é“¾æ¥*.txt
            *.log
          retention-days: 7