name: Test Clash Configurations

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    # paths:
    #   - 'clash-output-consistenthashing.yaml'
    #   - 'clash-config-template.yaml'
    #   - 'é“¾æ¥ç”Ÿæˆå™¨.js'
    #   - 'vmess-to-clash-converter.js'
    #   - 'package.json'
  pull_request:
    branches: [main, master]
    # paths:
    #   - 'clash-output-consistenthashing.yaml'
    #   - 'clash-config-template.yaml'
    #   - 'é“¾æ¥ç”Ÿæˆå™¨.js'
    #   - 'vmess-to-clash-converter.js'
    #   - 'package.json'

jobs:
  test-clash-configs:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ğŸ¤– Auto build')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Install dependencies
        run: npm install

      - name: Format code
        run: npm run format

      - name: Generate configurations
        run: npm run build

      - name: Test Clash configurations with Node.js
        run: |
          echo "ğŸ”„ ä½¿ç”¨ Node.js è„šæœ¬æµ‹è¯• Clash é…ç½®..."
          npm run test:clash

      - name: Download and install mihomo (clash core)
        run: |
          echo "ğŸ“¥ ä¸‹è½½ mihomo (clash core)..."
          # ä½¿ç”¨å®˜æ–¹çš„ mihomo äºŒè¿›åˆ¶æ–‡ä»¶
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz.gz -O mihomo.gz.gz

          echo "ğŸ“¦ è§£å‹ mihomo..."
          gunzip mihomo.gz.gz || gzip -d mihomo.gz.gz

          echo "ğŸ”§ æ·»åŠ æ‰§è¡Œæƒé™..."
          chmod +x mihomo

          echo "ğŸ” éªŒè¯ mihomo..."
          ./mihomo -v

      - name: Test clash configurations
        run: |
          set -e

          echo "ğŸ§ª å¼€å§‹æµ‹è¯• Clash é…ç½®æ–‡ä»¶..."

          # æ£€æŸ¥å¯ç”¨çš„é…ç½®æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥å¯ç”¨çš„é…ç½®æ–‡ä»¶..."
          available_configs=()

          # æ£€æŸ¥ä¸»è¦çš„ Clash é…ç½®æ–‡ä»¶
          if [ -f "clash-output-consistenthashing.yaml" ]; then
            available_configs+=("clash-output-consistenthashing.yaml")
            echo "   âœ… clash-output-consistenthashing.yaml"
          fi

          if [ -f "clash-config-template.yaml" ]; then
            available_configs+=("clash-config-template.yaml")
            echo "   âœ… clash-config-template.yaml"
          fi

          # æ£€æŸ¥å…¶ä»–å¯èƒ½çš„ Clash é…ç½®æ–‡ä»¶
          for config in clash-output-*.yaml clash-output-*.yml; do
            if [ -f "$config" ] && [[ ! " ${available_configs[@]} " =~ " ${config} " ]]; then
              available_configs+=("$config")
              echo "   âœ… $config"
            fi
          done

          if [ ${#available_configs[@]} -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½• Clash é…ç½®æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° mihomo: $(pwd)/mihomo"

          success_count=0
          total_count=${#available_configs[@]}
          failed_configs=()

          # æµ‹è¯•æ¯ä¸ªå®é™…å­˜åœ¨çš„é…ç½®æ–‡ä»¶
          for config in "${available_configs[@]}"; do
            echo ""
            echo "ğŸ“‹ æµ‹è¯•æ–‡ä»¶: $config"
            echo "   ğŸ§ª æµ‹è¯•é…ç½®è¯­æ³•..."

            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ•è·æµ‹è¯•ç»“æœ
            temp_output=$(mktemp)

            # æ‰§è¡Œ mihomo æµ‹è¯•å‘½ä»¤ï¼Œä½¿ç”¨set +eä¸´æ—¶ç¦ç”¨é”™è¯¯é€€å‡º
            set +e
            if timeout 30 ./mihomo -t -f "$config" > "$temp_output" 2>&1; then
              echo "   âœ… é…ç½®æ–‡ä»¶è¯­æ³•æµ‹è¯•é€šè¿‡!"
              ((success_count++))
              rm -f "$temp_output"
            else
              test_result=$?
              echo "   âŒ é…ç½®æ–‡ä»¶è¯­æ³•æµ‹è¯•å¤±è´¥ (é€€å‡ºç : $test_result)"
              failed_configs+=("$config")

              # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆé™åˆ¶è¡Œæ•°ä»¥é¿å…è¾“å‡ºè¿‡é•¿ï¼‰
              echo "   ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š"
              head -20 "$temp_output" 2>/dev/null || echo "   æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"

              # æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
              if [ $test_result -eq 124 ]; then
                echo "   â° æµ‹è¯•è¶…æ—¶ï¼ˆ30ç§’ï¼‰"
              fi

              rm -f "$temp_output"
            fi
            set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
          done

          echo ""
          echo "ğŸ“Š æµ‹è¯•ç»“æœ: $success_count/$total_count ä¸ªé…ç½®æ–‡ä»¶é€šè¿‡æµ‹è¯•"

          # æ˜¾ç¤ºå¤±è´¥çš„é…ç½®æ–‡ä»¶
          if [ ${#failed_configs[@]} -gt 0 ]; then
            echo ""
            echo "âŒ å¤±è´¥çš„é…ç½®æ–‡ä»¶ï¼š"
            for failed in "${failed_configs[@]}"; do
              echo "   - $failed"
            done
          fi

          if [ $success_count -eq $total_count ]; then
            echo ""
            echo "ğŸ‰ æ‰€æœ‰é…ç½®æ–‡ä»¶æµ‹è¯•é€šè¿‡!"
            echo "âœ… Clashé…ç½®éªŒè¯å®Œæˆ"
          else
            echo ""
            echo "âš ï¸  éƒ¨åˆ†é…ç½®æ–‡ä»¶æµ‹è¯•å¤±è´¥"
            echo "ğŸ“ è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•å’Œç»“æ„"
            echo "âœ… Clashé…ç½®éªŒè¯å®Œæˆ"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clash-test-results
          path: |
            *.yaml
            *.yml
          retention-days: 7
