好的，这是一个专门针对 `icmp9.sh` 脚本本身的详细中文说明文档。

## `icmp9.sh` 脚本详细说明

`icmp9.sh` 是一个功能强大的 Bash 脚本，旨在为 ICMP9.COM
的网络服务提供一个简单、自动化的客户端安装、配置和管理解决方案。它封装了所有复杂的底层操作，通过一个交互式菜单，让用户可以轻松地在自己的服务器上部署和使用网络代理服务。

### 核心功能

该脚本主要提供以下核心功能：

1. **一键安装与卸载**：自动检测系统环境、安装所需依赖、下载并配置核心程序，并能一键清理所有相关文件和服务。
2. **智能模式切换**：支持 **TUN 网卡模式** 和 **全局代理模式**
   两种工作模式，并允许用户在它们之间无缝切换。
3. **动态节点选择**：从远程 API
   获取最新的可用节点列表，并提供交互式界面供用户选择和切换。
4. **自动化服务管理**：根据不同的 Linux 发行版，自动创建并管理 `systemd`
   (Debian/Ubuntu) 或 `OpenRC` (Alpine Linux) 服务，实现开机自启和后台稳定运行。
5. **连接状态诊断**：内置连接测试功能，可以快速验证代理是否工作正常，并在出现问题时尝试自动修复。
6. **服务暂停与恢复**：提供临时暂停和恢复代理服务的功能，方便用户进行调试或临时使用直连网络。

### 工作原理

脚本通过一系列模块化的函数来完成其任务，其核心工作流程如下：

#### 1. 技术栈

- **Xray**: 核心代理工具，负责处理 VMess 协议的连接和数据转发。
- **tun2socks**: 在 TUN 模式下，负责将 TUN 网卡接收到的系统流量转发给 Xray 的
  SOCKS5 代理端口。
- **iptables**: 在全局代理模式下，用于创建 NAT 规则，透明地劫持和重定向系统的
  TCP 流量。
- **systemd / OpenRC**: Linux
  系统的服务管理器，用于确保代理服务能够开机自启和在后台稳定运行。

#### 2. 两种代理模式详解

脚本提供了两种不同的代理模式，以适应不同的网络环境：

- **TUN 网卡模式**
  - **工作方式**: 脚本会创建一个名为 `other` 的虚拟 TUN
    网卡。然后修改系统路由表，将所有流量（除了代理服务器本身和必要的直连地址）都指向这个虚拟网卡。`tun2socks`
    程序会监听这个网卡，将流经的流量数据通过 SOCKS5 协议转发给 Xray，最终由 Xray
    发送到远程节点。
  - **优点**:
    - 兼容性强，能处理所有类型的 TCP/UDP 流量。
    - 是 **纯 IPv6 环境下的首选模式**，因为它不依赖 iptables
      NAT，而是通过路由表工作。
    - 对系统应用的侵入性较小。
  - **缺点**: 性能上可能略有损耗。

- **全局代理模式**
  - **工作方式**: 脚本会使用 `iptables` 的 `nat` 表，创建一条 `OUTPUT`
    链的规则。这条规则会捕获所有发出的 TCP 连接，并将其重定向到 Xray
    的透明代理端口。Xray 接收到这些连接后，会根据其原始目标信息进行代理转发。
  - **优点**:
    - 性能通常较高，因为它在内核层面处理数据包。
    - 配置相对简单直接。
  - **缺点**:
    - 主要适用于 IPv4 环境。
    - 可能与其它依赖 `iptables` 的防火墙或代理软件产生冲突。

### 脚本结构解析

`icmp9.sh` 脚本内部结构清晰，主要分为以下几个功能模块：

- **系统检测与依赖管理**:
  - `detect_distro()`: 自动识别操作系统是 Alpine Linux 还是 Debian/Ubuntu。
  - `install_deps_alpine()` / `install_deps_debian()`:
    根据检测到的系统类型，使用 `apk` 或 `apt` 安装 `curl`, `jq`, `unzip`
    等必要工具。
  - 从 `api.icmp9.com` 下载与系统架构匹配的 `xray` 和 `tun2socks` 二进制文件。

- **配置获取与生成**:
  - `fetch_config()` / `fetch_nodes()`: 通过 `curl` 从 ICMP9.COM 的 API
    获取服务器配置（如地址、端口）和节点列表。
  - `generate_xray_config()`: 根据用户选择的节点、模式和 UUID，动态生成 Xray
    所需的 `json` 配置文件。

- **服务管理**:
  - `create_helper_scripts()`: 生成用于设置和拆除 TUN 网卡或 iptables
    规则的辅助脚本 (`tun-up.sh`, `tun-down.sh`, `global-up.sh`,
    `global-down.sh`)。
  - `create_services()`: 根据系统类型，创建 `systemd` 的 `.service` 文件或
    `OpenRC` 的 `init.d` 脚本。
  - `start_services()`, `stop_services()`, `restart_services()`:
    统一的接口，用于调用 `systemctl` 或 `rc-service` 来管理服务的生命周期。

- **用户界面 (UI)**:
  - `_header()`, `_line()`, `_info()`, `_ok()`, `_err()`:
    一系列用于美化输出、显示信息的函数。
  - `main_menu()`:
    脚本的主循环，显示一个交互式菜单，根据用户输入调用相应的功能函数（如
    `do_install()`, `do_switch_node()` 等）。

### 使用指南

1. **执行安装**:
   ```bash
   bash <(curl -L -s api.icmp9.com/icmp9.sh)
   ```
   首次运行会直接进入安装向导。

2. **日常管理**: 安装完成后，只需在终端中输入 `icmp9` 即可调出管理主菜单。
   ```bash
   icmp9
   ```
   通过菜单选项，您可以轻松地切换节点、更改模式、重启服务或查看状态。

3. **卸载**: 在管理菜单中选择 "卸载服务"
   选项，脚本会自动停止并删除所有相关的服务、配置文件和二进制程序。

### 文件与目录结构

脚本运行后，会在系统中创建以下关键文件和目录：

- `/etc/icmp9/`: 主配置目录。
  - `xray.json`: Xray 的核心配置文件。
  - `uuid`: 存储用户的 API Key (UUID)。
  - `state`: 存储当前选择的节点代码。
  - `mode`: 存储当前选择的代理模式。
  - `route_backup`: 备份原始路由信息，用于停止服务时恢复。
  - `tun-up.sh`, `tun-down.sh`, `global-up.sh`, `global-down.sh`:
    网络环境配置脚本。
- `/usr/local/bin/xray`: Xray 核心程序。
- `/usr/local/bin/tun2socks`: tun2socks 程序。
- `/etc/systemd/system/icmp9-*.service` (Debian/Ubuntu) 或 `/etc/init.d/icmp9-*`
  (Alpine Linux): 系统服务文件。

### 故障排除

- **安装失败**:
  - 检查服务器是否为支持的系统版本。
  - 确认拥有 `root` 权限。
  - 检查网络连接是否正常，能否访问 `api.icmp9.com`。
  - 确认服务器的 IPv4 地址已在 ICMP9.COM 用户中心的白名单中。

- **服务无法启动**:
  - 运行 `icmp9` 脚本，选择 "测试连接"，脚本会尝试自动诊断和修复。
  - 手动检查日志：
    - Debian/Ubuntu: `journalctl -u icmp9-xray -n 20`
    - Alpine Linux: `cat /var/log/icmp9-xray.log`

- **连接测试失败**:
  - 确认节点是否在线。
  - 检查服务器的防火墙是否阻止了出站连接。
  - 尝试重启服务。

**开发者信息**

- **版本**: 2.7
- **开发**: Claude (Anthropic)
- **许可**: MIT License
